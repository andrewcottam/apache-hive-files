--creates a spatial index on the species dataset by creating new geometries for each species that are the intersection of the species range with one degree cells. The resulting dataset contains the species id, the cell id, whether the intersection is completely covered by the cell, the intersection geometry and the area of the cell or the intersection geometry
SET hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
SET mapred.map.tasks=1000;
CREATE TABLE species.species_unique_2014_2_cells
STORED AS RCFILE
AS
SELECT
  id_no, cell, fully_covered, cell_intersect,
  IF(cell_intersect IS NULL, geotools_cell_area(cell, 1.0, "EPSG:4326", "EPSG:54009"), geotools_area(ST_Transform("EPSG:4326", "EPSG:54009", cell_intersect))) area
FROM (
  SELECT id_no, c.cell, c.fully_covered, IF(fully_covered, NULL, geotools_cell_intersects(1.0, c.cell, geom)) cell_intersect
  FROM species.species_unique_2014_2 LATERAL VIEW geotools_cells_udtf(1.0, geom) c
) sub;
SET hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;
